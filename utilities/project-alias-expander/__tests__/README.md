# PAE Testing Documentation

This directory contains comprehensive tests for the Project Alias Expander (PAE) tool following the FocusedUX Testing Strategy.

## Testing Structure Overview

This directory contains the standardized testing structure for the Context Cherry Picker Core package.

## Directory Structure

### üìÅ `__mocks__`

**Purpose**: Shared mocking utilities and helpers used across multiple test files. Not needed for one-off single mocks needed by individual test files.

Contains:

- `globals.ts` - Global mock configurations and utilities
- `helpers.ts` - Reusable mock helper functions
- `mock-scenario-builder.ts` - Builder pattern for creating complex mock scenarios
- `structure-auditor-guide.md` - Guide for maintaining test structure compliance
- `test-structure-violations.md` - Documentation of test structure violations

### üìÅ `_reports`

**Purpose**: Test execution reports and coverage data.

Contains:

- `coverage/` - Coverage reports generated by vitest

### üìÅ `coverage-tests`

**Purpose**: Tests solely designed to increase the coverage report percentage. These tests focus on covering edge cases and uncovered code paths.

Contains:

- `_readme.md` - Details about coverage-specific tests
- `trial-coverage-test.test-cov.ts` - Example coverage test file

### üìÅ `functional-tests`

**Purpose**: Main vitest test suites containing the core functionality tests. Can be broken down into sub-folders if test suites become too large.

Contains:

### üìÅ `isolated-tests`

**Purpose**: ADHOC one-off tests that are not run when executing the main test suite. Used for debugging, experimentation, or temporary test scenarios.

Contains:

- `_readme.md` - Details about isolated test usage and guidelines

## Testing Guidelines

1. **Functional Tests**: Place all main functionality tests in `functional-tests/`
2. **Coverage Tests**: Use `coverage-tests/` for tests that specifically target uncovered code paths
3. **Isolated Tests**: Use `isolated-tests/` for temporary or experimental tests
4. **Shared Mocks**: Use `__mocks__/` for reusable mock utilities
5. **Reports**: Coverage and test reports are automatically generated in `_reports/`

## Running Tests

- **All Tests**: `pnpm exec vitest run`
- **Functional Tests Only**: `pnpm exec vitest run functional-tests`
- **Coverage Tests Only**: `pnpm exec vitest run coverage-tests`
- **With Coverage**: `pnpm exec vitest run --coverage`

## Test Structure

### Functional Tests (`functional/`)

- **Purpose**: Test core CLI functionality and business logic
- **Scope**: Configuration loading, alias resolution, target expansion, flag expansion
- **Environment**: Isolated test environment with mocked dependencies

### Isolated Tests (`isolated-tests/`)

- **Purpose**: Test specific isolated functionality
- **Scope**: Individual functions and edge cases
- **Environment**: Highly controlled test environment

### Coverage Tests (`coverage/`)

- **Purpose**: Generate and analyze test coverage reports
- **Scope**: Coverage analysis and reporting
- **Environment**: Coverage-enabled test runs

## Test Categories

### 1. Configuration Management

- Loading and parsing `config.json`
- Handling missing or invalid configuration files
- JSON comment stripping functionality

### 2. Alias Resolution

- Simple string alias resolution
- Object-based alias resolution with suffixes
- Integration test routing logic
- Full package semantics

### 3. Target Expansion

- Target shortcut expansion (`b` ‚Üí `build`)
- Unknown target handling
- Multi-word target expansion

### 4. Flag Expansion

- Single flag expansion (`-f` ‚Üí `--fix`)
- Bundled flag expansion (`-fs` ‚Üí `--fix --skip-nx-cache`)
- Unknown flag handling

### 5. PowerShell Module Generation

- Module content generation
- Directory creation
- File writing operations
- Export statement generation

### 6. Command Execution

- Nx command execution
- Non-Nx command execution
- Echo mode functionality
- Error handling

### 7. Multi-Project Operations

- Extension package operations (`ext`)
- Core package operations (`core`)
- All package operations (`all`)

## Test Execution

### Standard Tests

```bash
# Run functional tests
nx test project-alias-expander

# Run with PAE aliases
pae test
```

### Full Test Suite

```bash
# Run entire dependency chain
nx test:full project-alias-expander

# Run with PAE aliases
pae test:full
```

### Coverage Tests

```bash
# Run with coverage
nx run project-alias-expander:test --coverage

# Run with PAE aliases
pae tc
```

## Mocking Strategy

### External Dependencies

- **`strip-json-comments`**: Mocked for JSON parsing tests
- **`fs`**: Mocked for file system operations
- **`path`**: Mocked for path manipulation
- **`process`**: Mocked for environment and process control
- **`child_process`**: Mocked for command execution

### Test Helpers

- **`setupTestEnvironment()`**: Creates mock instances
- **`resetAllMocks()`**: Cleans up mocks between tests
- **`setupFileSystemMocks()`**: Configures file system mocks
- **`setupPathMocks()`**: Configures path manipulation mocks

## Quality Gates

- [ ] All configuration loading scenarios tested
- [ ] All alias resolution patterns tested
- [ ] All target expansion scenarios tested
- [ ] All flag expansion patterns tested
- [ ] PowerShell module generation tested
- [ ] Command execution tested
- [ ] Multi-project operations tested
- [ ] Error handling tested
- [ ] Edge cases covered
- [ ] 100% test coverage for business logic

## Test Data

### Sample Configuration

```json
{
    "targets": {
        "b": "build",
        "t": "test",
        "l": "lint"
    },
    "packages": {
        "test": "test-package",
        "pbc": {
            "name": "project-butler",
            "suffix": "core"
        }
    }
}
```

### Test Scenarios

- Valid configuration loading
- Invalid JSON handling
- Missing file handling
- Empty configuration handling
- Complex alias resolution
- Multi-word target expansion
- Bundled flag expansion
- PowerShell module generation
- Command execution simulation
