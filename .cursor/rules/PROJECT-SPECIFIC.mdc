---
alwaysApply: true
---

## **Project Workflow Patterns**

### **Nx Workspace Conventions**

- **Build Commands:** Use `{alias} b` for building packages
- **Test Commands:** Use `{alias} t` for running tests
- **Lint Commands:** Use `{alias} l` for linting packages
- **Type Checking:** Use `{alias} tsc` for TypeScript compilation checks

### **Package Management**

- **Package Manager:** Use `pnpm` as the primary package manager
- **Workspace Commands:** Leverage Nx workspace commands for cross-package operations
- **Dependency Management:** Use workspace dependencies (`workspace:*`) for internal packages

---

## **Testing Infrastructure**

### **Mockly Library Usage**

- **Mock Coverage:** Use mockly services where available for VSCode API mocking
- **Fallback Strategy:** Create manual mocks for services not covered by mockly
- **Test Isolation:** Always reset mock state between tests using `mocklyService.reset()`

### **Integration Test Resolution (DI-First)**

- Prefer resolving services via the DI container (`createDIContainer`) for integration/behavior tests
- Override adapters with Mockly shims via container registration (e.g., `iWorkspace`, `iWindow`, `iEnv`)
- Use constructor wiring only for tightly scoped unit tests that require strict isolation

### **Mockly Usage Rules**

- Use `mockly.workspace.fs` and `mockly.node.*` shims instead of ad-hoc mocks wherever possible
- Normalize paths in assertions for cross-platform consistency: replace `\\` with `/` before comparing
- Preserve document semantics: `MockTextDocument` reflects exact content including trailing newlines; assert against `getText()` accordingly

### **Test Console Output**

- **Environment Variable:** Use `ENABLE_TEST_CONSOLE=true` to enable console output in tests
- **Programmatic Control:** Use `enableTestConsoleOutput()` function for specific test suites
- **Debugging:** Console output is suppressed by default; enable only when needed for debugging

---

## **File Organization**

### **Project Structure**

- **Packages:** Located in `packages/` directory
- **Libraries:** Located in `libs/` directory
- **Documentation:** Located in `docs/` directory
- **Configuration:** Root-level configuration files (`.cursor/rules/`, `nx.json`, etc.)

### **Documentation Standards**

- **Actions Log:** Update `docs/Actions-Log.md` for successful implementations
- **Testing Strategy:** Update `packages/note-hub/ext/__tests__/TESTING_STRATEGY.md` for test-related fixes
- **Project Rules:** Keep project-specific rules in this file
- **MANDATE – Post-Change Documentation:** After a correctly finalized implementation:
    - Append a concise entry to `docs/Actions-Log.md` summarizing the change, outcomes, and lessons
    - If the change affects testing for a package, update that package’s `__tests__/TESTING_STRATEGY.md` with the new guidance/examples
    - Do this in the same session as the change; do not defer

---

## **Quality Assurance**

### **Build Verification**

- **Pre-Execution:** Always run `{alias} b` before testing to ensure clean builds
- **Error Resolution:** Fix build errors before proceeding with other operations
- **Cache Management:** Use `--skip-nx-cache` when troubleshooting build issues

### **Test Execution**

- **Full Test Suite:** Run complete test suites to ensure no regressions
- **Test Isolation:** Ensure tests don't interfere with each other
- **Mock Validation:** Verify that mocks properly simulate the behavior they're replacing
- **Lanes:**
    - `t` runs project tests (no coverage)
    - `tc`/`tcw` run tests with coverage; do not enable coverage in generic test targets
    - Build-before-test is enabled via Nx target defaults and uses cache; avoid `-s` unless diagnosing cache issues

---

## **Project Requirements (Static)**

The following principles must ALWAYS be followed as they are part of the project's foundational structure:

- **VSCode API Import Rules:** Value imports for VSCode APIs and Node must come only from shared adapters
    - Direct VSCode imports should be limited to types only, to keep code decoupled and allow complete injection.

### Shared Adapter Change Protocol

- When modifying shared adapters or VSCode-coupled shims in `libs/shared`, you MUST:
    - Identify and update all consumers (imports, DI wiring) in affected packages within the same session
    - Verify TypeScript path mappings for `@fux/shared` across projects to keep type checks green
    - Run `nh tsc` and the auditor afterwards; fix any fallout immediately

### Auditor Behavior & Ergonomics

- Canonical tsconfig enforcement must remain minimal; do not enforce non-essential keys (e.g., `rootDir`) unless required
- Provide a warn-only mode for auditor tasks to surface issues without failing developer workflows when appropriate

---

## **Command Execution & Tooling**

### **Build Tool Preferences**

- Use `--skip-nx-cache` for troubleshooting Nx build issues unless otherwise specified
- Prefer `pnpm` over `npm` for all package management tasks

### **PowerShell Profile and Aliases Setup**

- **CRITICAL**: At the beginning of each chat session, the AI assistant MUST follow these step-by-step instructions: 3. **Use Custom Aliases**: When a command has a custom alias configured in `.vscode/shell/pnpm_aliases.json`, use the custom alias instead of the native command, unless the native command is referenced in the posed question or request 4. **Testing Protocol**: When testing the alias file itself, run the native command first, followed by the alias command to compare behavior:

            ```powershell
            # Example: Test both native and alias versions
            pnpm run build --filter=ghost-writer
            gw b
            ```

    5. **FAILURE RECOVERY**: If profile loading fails, immediately halt all operations and report the failure before proceeding with any other tasks

#### PowerShell Alias Scripting Hygiene

- Generate alias functions using single-quoted here-strings; substitute dynamic values via placeholder replacement
- Avoid backtick-escaping `$` in here-strings; prefer placeholders and `.Replace()` before creating script blocks

---

### **Terminal Defaults (PowerShell)**

- **CRITICAL – Preloaded Environment:** The integrated terminal runs PowerShell with the workspace profile automatically loaded. The `aka` CLI and all defined aliases are immediately available. Do not manually source the profile or activate aliases.
- **Command Semantics:** This is a PowerShell environment. Avoid Unix-only patterns like piping to `cat`. Use native PowerShell constructs instead (e.g., no `| cat`).

> **Note:** This document contains project-specific rules that complement the universal APE Doctrine. Always refer to the APE Doctrine for universal principles, and use this document for project-specific workflows and conventions.
